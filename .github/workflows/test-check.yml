name: Get Latest StackHawk Scan

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Git SHA to search for (leave empty for current HEAD)'
        required: false
        default: ''
      config-path:
        description: 'Path to stackhawk.yml config file'
        required: false
        default: 'stackhawk.yml'

jobs:
  get-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest StackHawk scan for commit
        id: get-scan
        env:
          STACKHAWK_API_KEY: ${{ secrets.STACKHAWK_API_KEY }}
          CONFIG_PATH: ${{ github.event.inputs.config-path || 'stackhawk.yml' }}
          INPUT_APP_ID: ${{ github.event.inputs.application-id }}
        run: |
          set -e
          
          # Get app ID from input or config file
          if [ -n "$INPUT_APP_ID" ]; then
            APP_ID="$INPUT_APP_ID"
            echo "Using application ID from input: $APP_ID"
          else
            # Extract app ID from stackhawk.yml
            if [ ! -f "$CONFIG_PATH" ]; then
              echo "::error::Config file not found: $CONFIG_PATH"
              exit 1
            fi
            
            echo "Extracting application ID from $CONFIG_PATH..."
            APP_ID=$(yq eval '.app.applicationId' "$CONFIG_PATH")
            
            if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
              echo "::error::Could not find app.applicationId in $CONFIG_PATH"
              exit 1
            fi
            
            echo "Application ID from config: $APP_ID"
          fi
          
          # Get SHA if not provided
          SHA="${{ github.event.inputs.sha }}"
          if [ -z "$SHA" ]; then
            SHA=$(git rev-parse HEAD)
            echo "Using current HEAD SHA: $SHA"
          fi
          
          # Authenticate
          echo "Authenticating with StackHawk API..."
          AUTH_RESPONSE=$(curl -s -X POST https://api.stackhawk.com/api/v1/auth/login \
            -H "Content-Type: application/json" \
            -H "X-ApiKey: $STACKHAWK_API_KEY")
          
          TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.token')
          ORG_ID=$(echo "$AUTH_RESPONSE" | jq -r '.orgId')
          
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "::error::Authentication failed"
            exit 1
          fi
          
          echo "Authenticated. Org ID: $ORG_ID"
          
          # List scans
          echo "Fetching scans for application $APP_ID..."
          SCANS_RESPONSE=$(curl -s -X GET \
            "https://api.stackhawk.com/api/v1/scan/${ORG_ID}?appIds=${APP_ID}&sortDir=desc&pageSize=100" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json")
          
          # Find scan with matching SHA
          SCAN=$(echo "$SCANS_RESPONSE" | jq -r --arg sha "$SHA" \
            '.applicationScanResults[] | select(.scan.sha == $sha or .scan.gitCommitSha == $sha) | .scan | @json' | head -n1)
          
          if [ -z "$SCAN" ] || [ "$SCAN" = "null" ]; then
            echo "::warning::No scan found with SHA $SHA"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract scan details
          SCAN_ID=$(echo "$SCAN" | jq -r '.scanId')
          SCAN_STATUS=$(echo "$SCAN" | jq -r '.status')
          SCAN_APP_ID=$(echo "$SCAN" | jq -r '.applicationId')
          ENV_ID=$(echo "$SCAN" | jq -r '.environmentId')
          SCAN_URL="https://app.stackhawk.com/scans/${ORG_ID}/${SCAN_APP_ID}/${ENV_ID}/${SCAN_ID}"
          
          # Set outputs
          echo "found=true" >> $GITHUB_OUTPUT
          echo "scan-id=$SCAN_ID" >> $GITHUB_OUTPUT
          echo "scan-url=$SCAN_URL" >> $GITHUB_OUTPUT
          echo "scan-status=$SCAN_STATUS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Scan found!"
          echo "   Scan ID: $SCAN_ID"
          echo "   Status: $SCAN_STATUS"
          echo "   View: $SCAN_URL"
          echo ""

      - name: Display results
        if: steps.get-scan.outputs.found == 'true'
        run: |
          echo "### StackHawk Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.get-scan.outputs.scan-status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Full Results](${{ steps.get-scan.outputs.scan-url }})" >> $GITHUB_STEP_SUMMARY
