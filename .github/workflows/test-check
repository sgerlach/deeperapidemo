name: 'Get Latest StackHawk Scan'
description: 'Fetches the latest StackHawk scan result for the current git commit SHA'
author: 'StackHawk'

inputs:
  api-key:
    description: 'StackHawk API Key'
    required: true
  application-id:
    description: 'StackHawk Application ID'
    required: true
  sha:
    description: 'Git commit SHA to search for (defaults to current HEAD)'
    required: false
    default: ''

outputs:
  scan-id:
    description: 'The UUID of the matching scan'
    value: ${{ steps.get-scan.outputs.scan-id }}
  scan-url:
    description: 'URL to view the scan in StackHawk platform'
    value: ${{ steps.get-scan.outputs.scan-url }}
  scan-status:
    description: 'Status of the scan (SUCCESS, ERRORED, IN_PROGRESS)'
    value: ${{ steps.get-scan.outputs.scan-status }}
  found:
    description: 'Whether a matching scan was found (true/false)'
    value: ${{ steps.get-scan.outputs.found }}

runs:
  using: 'composite'
  steps:
    - name: Get StackHawk Scan
      id: get-scan
      shell: bash
      env:
        STACKHAWK_API_KEY: ${{ inputs.api-key }}
        APP_ID: ${{ inputs.application-id }}
        SHA: ${{ inputs.sha }}
      run: |
        set -e
        
        # Get SHA if not provided
        if [ -z "$SHA" ]; then
          SHA=$(git rev-parse HEAD)
          echo "Using current HEAD SHA: $SHA"
        fi
        
        # Authenticate
        echo "Authenticating with StackHawk API..."
        AUTH_RESPONSE=$(curl -s -X POST https://api.stackhawk.com/api/v1/auth/key \
          -H "Content-Type: application/json" \
          -d "{\"key\":\"$STACKHAWK_API_KEY\"}")
        
        TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.token')
        ORG_ID=$(echo "$AUTH_RESPONSE" | jq -r '.orgId')
        
        if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
          echo "::error::Authentication failed"
          exit 1
        fi
        
        echo "Authenticated. Org ID: $ORG_ID"
        
        # List scans
        echo "Fetching scans for application $APP_ID..."
        SCANS_RESPONSE=$(curl -s -X GET \
          "https://api.stackhawk.com/api/v1/scan/${ORG_ID}?appIds=${APP_ID}&sortDir=desc&pageSize=100" \
          -H "Authorization: Bearer $TOKEN" \
          -H "Accept: application/json")
        
        # Find scan with matching SHA
        SCAN=$(echo "$SCANS_RESPONSE" | jq -r --arg sha "$SHA" \
          '.applicationScanResults[] | select(.scan.sha == $sha or .scan.gitCommitSha == $sha) | .scan | @json' | head -n1)
        
        if [ -z "$SCAN" ] || [ "$SCAN" = "null" ]; then
          echo "::warning::No scan found with SHA $SHA"
          echo "found=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Extract scan details
        SCAN_ID=$(echo "$SCAN" | jq -r '.scanId')
        SCAN_STATUS=$(echo "$SCAN" | jq -r '.status')
        APP_ID=$(echo "$SCAN" | jq -r '.applicationId')
        ENV_ID=$(echo "$SCAN" | jq -r '.environmentId')
        SCAN_URL="https://app.stackhawk.com/scans/${ORG_ID}/${APP_ID}/${ENV_ID}/${SCAN_ID}"
        
        # Set outputs
        echo "found=true" >> $GITHUB_OUTPUT
        echo "scan-id=$SCAN_ID" >> $GITHUB_OUTPUT
        echo "scan-url=$SCAN_URL" >> $GITHUB_OUTPUT
        echo "scan-status=$SCAN_STATUS" >> $GITHUB_OUTPUT
        
        echo "âœ… Scan found!"
        echo "   Scan ID: $SCAN_ID"
        echo "   Status: $SCAN_STATUS"
        echo "   View: $SCAN_URL"
